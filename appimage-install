#!/usr/bin/env bash
set -euo pipefail

# Uso:
#   appimage-install /caminho/Para/App.AppImage "Nome do App" [--comment "texto"] [--icon /caminho/icone.png|URL] [--categories "Network;Utility;"] [--copy]
#
# Exemplos:
#   appimage-install ~/Downloads/Ferdium-*.AppImage Ferdium --comment "Mensagens num só sítio"
#   appimage-install ~/Downloads/Obsidian-*.AppImage Obsidian --icon https://.../icon.png --categories "Office;Utility;"

err() { echo "Erro: $*" >&2; exit 1; }

need_cmd() { command -v "$1" >/dev/null 2>&1 || err "Comando '$1' não encontrado"; }

if [[ $# -lt 2 ]]; then
  err "Uso: $0 /caminho/AppImage \"Nome\" [--comment ...] [--icon ...] [--categories ...] [--copy]"
fi

APPIMAGE_PATH="$1"
APP_NAME="$2"
shift 2

COMMENT=""
ICON_SRC=""
CATEGORIES="Utility;"
DO_COPY="0"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --comment) COMMENT="${2:-}"; shift 2 ;;
    --icon) ICON_SRC="${2:-}"; shift 2 ;;
    --categories) CATEGORIES="${2:-}"; shift 2 ;;
    --copy) DO_COPY="1"; shift 1 ;;
    *) err "Opção desconhecida: $1" ;;
  esac
done

# Resolve o caminho real da AppImage (para lidar com wildcards expandidos)
APPIMAGE_PATH="$(readlink -f "$APPIMAGE_PATH" 2>/dev/null || echo "$APPIMAGE_PATH")"
[[ -f "$APPIMAGE_PATH" ]] || err "AppImage não existe: $APPIMAGE_PATH"

# “slug” simples para nomes de ficheiro
SLUG="$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g')"
[[ -n "$SLUG" ]] || err "Nome inválido"

BIN_DIR="$HOME/.local/bin"
APP_DIR="$HOME/.local/share/applications"
ICON_DIR="$HOME/.local/share/icons"

mkdir -p "$BIN_DIR" "$APP_DIR" "$ICON_DIR"

DEST_APPIMAGE="$BIN_DIR/${SLUG}.AppImage"
DESKTOP_FILE="$APP_DIR/${SLUG}.desktop"
DEST_ICON="$ICON_DIR/${SLUG}.png"

# Copiar ou mover
if [[ "$DO_COPY" == "1" ]]; then
  cp -f "$APPIMAGE_PATH" "$DEST_APPIMAGE"
else
  mv -f "$APPIMAGE_PATH" "$DEST_APPIMAGE"
fi

chmod +x "$DEST_APPIMAGE"

# Ícone (opcional)
ICON_LINE="Icon=${SLUG}"
if [[ -n "$ICON_SRC" ]]; then
  if [[ "$ICON_SRC" =~ ^https?:// ]]; then
    need_cmd curl
    curl -fsSL "$ICON_SRC" -o "$DEST_ICON" || err "Falha ao descarregar ícone"
    ICON_LINE="Icon=${DEST_ICON}"
  else
    [[ -f "$ICON_SRC" ]] || err "Ícone não existe: $ICON_SRC"
    cp -f "$ICON_SRC" "$DEST_ICON"
    ICON_LINE="Icon=${DEST_ICON}"
  fi
fi

# Comment default se não for dado
if [[ -z "$COMMENT" ]]; then
  COMMENT="Aplicação AppImage integrada no sistema"
fi

cat > "$DESKTOP_FILE" <<EOF
[Desktop Entry]
Name=${APP_NAME}
Comment=${COMMENT}
Exec=${DEST_APPIMAGE}
${ICON_LINE}
Terminal=false
Type=Application
Categories=${CATEGORIES}
StartupWMClass=${APP_NAME}
EOF

chmod 644 "$DESKTOP_FILE"

# Atualiza menu (se existir)
if command -v update-desktop-database >/dev/null 2>&1; then
  update-desktop-database "$APP_DIR" >/dev/null 2>&1 || true
fi

echo "OK!"
echo "AppImage:  $DEST_APPIMAGE"
echo "Atalho:    $DESKTOP_FILE"
[[ -n "$ICON_SRC" ]] && echo "Ícone:     $DEST_ICON"
echo "Agora já aparece no menu. Podes fixar na dock."
